# 12.16美化ImGui & 修复相机视角跳变

ImGui的美化，主要就是把面板的各个部分进一步抽象，并且客制化了imgui的窗口的各种样式和配色，目前浅色模式有些问题。

主要说说相机视角跳变问题吧。

## 情况

当我们切换相机模式（FPS & Arcball）时，或点击其它imgui窗口再重新聚焦到视口时，这两种情况均会发生视角跳变。

## 解决

### FirstMouse逻辑

在EditorCamera::OnUpdate中，我设置了

```
m_MouseButtoned =	
	Input::IsMouseButton(SNL_MOUSE_BUTTON_LEFT) ||				Input::IsMouseButton(SNL_MOUSE_BUTTON_MIDDLE) ||			Input::IsMouseButton(SNL_MOUSE_BUTTON_RIGHT);

float currentMouseX = Input::GetMouseX();
float currentMouseY = Input::GetMouseY();

// 初始化偏移量为 0
float xoffset = 0.0f;
float yoffset = 0.0f;

if (m_MouseButtoned) {
	if (!m_IsDragging) {
		// --- 拖拽的第一帧 ---
		m_IsDragging = true;
		m_LastMouseX = currentMouseX;
		m_LastMouseY = currentMouseY;
	}
	else {
		// --- 拖拽的后续帧 ---
		xoffset = currentMouseX - m_LastMouseX;
		yoffset = m_LastMouseY - currentMouseY; // 反写适应OpenGL

		m_LastMouseX = currentMouseX;
		m_LastMouseY = currentMouseY;
	}
}
else {
	m_IsDragging = false;
}
```

①获取当前鼠标是否按下了：左键 | 中键 | 右键？

②获取当前鼠标的坐标，初始化偏移量为0

③先检查①的状态，如果没有按下，直接不更新相机视角（保持偏移量为0），并且**确保m_IsDragging**表示鼠标是否在拖拽的状态为**false**

④再检查m_IsDragging的状态，m_IsDragging已经在上一次拖拽结束后被设置为false，所以如果**m_IsDragging=false就是拖拽第一帧**，

这时只是设置成员m_LastMouseX & m_LastMouseY 表示的是上一帧的鼠标坐标，**不更新偏移量**，这样下一帧的偏移量就是基于第一次鼠标点击到的坐标；

否则就是**拖拽的后续帧**，正常缓存上一帧的鼠标坐标，并且**更新偏移量**，这样才能真正地更新相机的视角。



> 这样实现后，我发现仍然有问题，并且多次问ai也无果



### 粗心大意

编辑层持有编辑器相机，所以编辑器相机的OnUpdate方法目前在编辑层的OnUpdate调用，修改之前是这样的：

```
if (m_EVpanel.IsFocused()) {
    m_EditorCamera->OnUpdate(ts);
}
```

可以发现，这里的逻辑是：**我需要视口面板被聚焦，才更新相机的外部属性**

因为之前m_EditorCamera->OnUpdate只包含键盘的更新逻辑，这对于FPS模式下的键盘控制移动没有问题；但是对于鼠标操作，我的逻辑是希望不论哪个窗口被聚焦，只要光标悬浮在视口，就要对应更新相机的属性。

所以，在我把鼠标操作也添加到OnUpdate之后，这里原本就存在一个逻辑漏洞，正确逻辑是这样的：

```
if (m_EVpanel.IsFocused() || m_EVpanel.IsHovered()) {
    m_EditorCamera->OnUpdate(ts);
}
```

那么为什么会导致鼠标跳变呢？

因为当我从其它窗口的聚焦状态切换到视口聚焦的一瞬间，条件m_EVpanel.IsFocused()由0变1，相机OnUpdate方法由不调用变调用，所以现象就是我多点击几次视口确保聚焦，再动视角就不会跳变，只要直接变动视角就会跳变；

而条件m_EVpanel.IsFocused() || m_EVpanel.IsHovered()在鼠标进入视口的一瞬间就是true，相机OnUpdate始终更新。

## 问题

但是目前，不同相机模式的切换还是会导致视角跳变，我觉得可能是因为，不同模式之间使用的属性更新不同步，或者是视角的变化速度不太一致，都可能是跳变的原因，但是目前没有去解决了。

另外一个问题就是，现在只要鼠标悬浮，FPS模式下也能通过键盘控制移动了，这样如果在其它面板聚焦输入时，恰好光标又处在视口上，就会错误的移动相机。不过我觉得这个也不是经常发生的情况，暂时不去修改。