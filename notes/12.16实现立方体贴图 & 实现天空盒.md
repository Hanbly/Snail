# 12.16实现立方体贴图 & 实现天空盒

## 1.立方体贴图

Cube Maps 是纹理的一种，对照着2D纹理来看，2D纹理包含一个渲染ID、一个贴图资源；而cube纹理包含一个渲染ID、六个贴图资源。

也就是说，一个立方体贴图，是六个贴图资源，分别组装到一个立方体的六个面上；但是与字面意思不同的是，立方体贴图不仅可以应用在立方体之上，它的原理是通过一个方向向量来进行索引/采样。假设我们有一个1x1x1的单位立方体，方向向量的原点位于它的中心。使用一个橘黄色的方向向量来从立方体贴图上采样一个纹理值会像是这样：

![cubemaps_sampling](images\cubemaps_sampling.png)

创建它的方法跟2D纹理差不多，唯独需要分别加载六个贴图资源，再整合到一个纹理对象中，这里不详细说了。

## 2.天空盒

天空盒就是立方体贴图的一个应用。

由于天空盒是绘制在一个立方体上的，和其它物体一样，我们需要另一个VAO、VBO以及新的一组顶点。

用于贴图3D立方体的立方体贴图可以使用立方体的位置作为纹理坐标来采样。当立方体处于原点(0, 0, 0)时，它的每一个位置向量都是从原点出发的方向向量。这个方向向量正是获取立方体上特定位置的纹理值所需要的。正是因为这个，我们只需要提供位置向量而不用纹理坐标了。

新的shader：

```
#type vertex
#version 330 core

layout (location = 0) in vec3 aPos;

out vec3 v_TexCoords;

uniform mat4 u_ViewProjection;

void main()
{
    v_TexCoords = aPos;

    vec4 pos = u_ViewProjection * vec4(aPos, 1.0);
    gl_Position = pos.xyww;
}

#type fragment
#version 330 core

out vec4 FinalColor; // 最终输出到屏幕

in vec3 v_TexCoords;

uniform samplerCube u_Cubemap1;

void main()
{
    FinalColor = texture(u_Cubemap1, v_TexCoords);
}
```

其中gl_Position = pos.xyww;是将输出位置的z分量等于它的w分量，让z分量永远等于1.0，这样子的话，当**透视除法**执行之后，z分量会变为`w / w = 1.0`。

**透视除法**是在顶点着色器运行之后执行的，将gl_Position的`xyz`坐标除以w分量。我们又从[深度测试](https://learnopengl-cn.github.io/04 Advanced OpenGL/01 Depth testing/)小节中知道，相除结果的z分量等于顶点的深度值。

此外，修改深度测试的函数：GL_LESS -> GL_LEQUAL

这能让我们在判断天空盒的深度值时，由**小于**变成**小于等于**。

## 3.环境映射

这部分比较复杂，能通过立方体贴图把周围环境的纹理映射到物体上，之后再实现。