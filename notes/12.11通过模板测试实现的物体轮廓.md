 12.11通过模板测试实现的物体轮廓

之前我们通过鼠标射线盒AABB检测盒实现了鼠标射线拾取物体，今天来继续实现物理轮廓的效果。

## 1.模板测试

当片段着色器处理完一个片段之后，模板测试(Stencil Test)会开始执行，和深度测试一样，它也可能会丢弃片段。接下来，被保留的片段会进入深度测试，它可能会丢弃更多的片段。模板测试是根据又一个缓冲来进行的，它叫做模板缓冲(Stencil Buffer)，我们可以在渲染的时候更新它来获得一些很有意思的效果。

#### 模板测试的数据写入

模板测试简单来说就是一个由0、1组成的缓冲区，开启模板测试后，我们就可以把数据写入模板缓冲区，然后我们可以通过：

glStencilMask(0xFF); // 每一位写入模板缓冲时都保持原样
glStencilMask(0x00); // 每一位在写入模板缓冲时都会变成0

来控制写入缓冲区的数据，基本上就是0xFF表示写入，而0x00表示禁止写入。

那么写入的数据从哪来呢？答案是：只要开启模板测试，每次绘制命令都会试图写入模板缓冲区，所以我们只需要在希望写入的绘制命令之前使用glStencilMask(0xFF)，在不希望的命令前使用glStencilMask(0x00)即可。

通过glStencilOp(GLenum sfail, GLenum dpfail, GLenum dppass)函数来控制，默认情况下glStencilOp是设置为`(GL_KEEP, GL_KEEP, GL_KEEP)`的，这时不论任何测试的结果是如何，模板缓冲都会保留它的值；

#### 模板测试的数据读取

模板测试的数据读出我们称之为测试通过，反之则是测试失败被忽略。

对于模板缓冲区的数据读取策略，我们有一些模板函数进行控制：

glStencilFunc(GLenum func, GLint ref, GLuint mask)函数的参数分别是：测试函数（测试进行的操作）、所要比较的值（取0或1）、一个掩码，它将会与参考值和储存的模板值在测试比较它们之前进行与(AND)运算；

例如 `glStencilFunc(GL_EQUAL, 1, 0xFF)`

## 2.物体轮廓

要显示物体轮廓，要做的事本质上是两步;

①正常绘制物体

②绘制一个轮廓



这一步怎么做？之前我们说的模板测试会在绘制命令时把数据写入它的缓冲区，所以当第一步执行前，我们可以启用写入：

glStencilMask(0xFF); // 每一位写入模板缓冲时都保持原样

然后正常绘制物体；





中间这一步是关键，我们给物体的转置矩阵叠加一个缩放矩阵：

SetMat4("u_Model", glm::scale(transform, glm::vec3(1.03f, 1.03f, 1.03f)))

这样得到的shader会绘制出一个比物体大一圈的另一个物体；





之后进入绘制轮廓的流程，

RendererCommand::StencilMask(false); // 不再写入模板，只读取模板信息
RendererCommand::StencilFunc(RendererCommand::StencilFuncType::NOTEQUAL, 1, 0xFF);

禁用写入模板，然后设置读取策略为NOTEQUAL，意思是扣掉物体原本的范围的数据；





至此可以表示为以下流程：

![屏幕截图 2025-12-11 214355](images\屏幕截图 2025-12-11 214355.png)

因为此时原本物体的范围被缓冲区禁用了，而扩大一圈的那个物体的多出部分则被置为1，这时我们调用绘制命令绘制新的物体，就会只让多余的部分通过模板测试，也就是只绘制了边框。



最后，我们

RendererCommand::StencilMask(true);
RendererCommand::StencilFunc(RendererCommand::StencilFuncType::ALWAYS, 1, 0xFF);

glStencilMask(0xFF);
//         颜色缓冲区               深度测试缓冲区           模板测试缓冲区
glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT | GL_STENCIL_BUFFER_BIT);

启用写入；并设置读取策略为默认的ALWAYS，ALWAYS意思大概就是不管通过不通过，都绘制，就像我们没有启用模板测试一样；并清空缓冲区数据，因为缓冲区也是需要每帧更新的，而glStencilMask(0xFF)是为了确保写入启用，如果未启用，OpenGL甚至无法清空缓冲区。

<video src="F:\Snail\notes\images\屏幕录制 2025-12-11 154639.mp4"></video>

<video src="F:\Snail\notes\images\屏幕录制 2025-12-11 154057.mp4"></video>

