运行时库

- LINK : warning LNK4098: 默认库“MSVCRTD”与其他库的使用冲突；请使用 /NODEFAULTLIB:library
- LINK : warning LNK4217: 符号“free”...已由“GLFW.lib”...导入
- Application.obj : error LNK2019: 无法解析的外部符号 ... Snail::Window::SNLCreateWindow ...
- GLFW.lib(init.obj) : error LNK2019: 无法解析的外部符号 __imp_realloc ...

这些看似分散的错误，实际上都指向了一个共同的根源。

------



# **11.18运行时库设置不一致**

C++运行时库（CRT）是一系列函数的集合，提供了程序运行所需的基础功能，如内存管理 (malloc, free)、字符串操作 (strcpy)、输入输出 (printf) 等。

在 Visual Studio 中，运行时库有四种主要配置：

1. **多线程 DLL (/MD)**: Release 版本，动态链接 CRT。程序运行时需要 msvcp<version>.dll 和 vcruntime<version>.dll。
2. **多线程调试 DLL (/MDd)**: Debug 版本，动态链接 CRT。程序运行时需要 msvcp<version>d.dll 和 vcruntime<version>d.dll。
3. **多线程 (/MT)**: Release 版本，静态链接 CRT。所有 CRT 代码被编译进你的 .exe 或 .dll，不依赖外部 DLL。
4. **多线程调试 (/MTd)**: Debug 版本，静态链接 CRT。

**你遇到的问题是：**

> 在你的解决方案中，不同的项目模块（你的 Snail 库、你的 Example 程序、以及你引用的第三方库 GLFW.lib）被配置为使用**不同种类**的运行时库。

### **问题表现与原因分析**

1. **LNK4098 警告**: 这是最直接的信号。MSVCRTD.lib 是 /MTd（多线程调试静态）的库。这个警告告诉你，链接器同时看到了请求静态链接 CRT 的模块和请求动态链接 CRT 的模块，它不知道该听谁的，于是发出了冲突警告。
2. **LNK4217 和 LNK4286 警告**: 这些警告表明同一个函数（如 free）在多个地方有定义或导入。这通常发生在混合使用静态和动态 CRT 时。例如，libucrtd.lib (动态 CRT 的一部分) 和 GLFW.lib (可能被编译为静态 CRT) 都试图提供 free 函数的实现，导致了符号冲突。
3. **LNK2019 无法解析的外部符号 (如 __imp_realloc)**: 当你的项目配置为动态链接 CRT（/MDd）时，它期望从 CRT 的 DLL 中导入函数，这些函数的符号名通常带有 __imp_ 前缀。如果链接器因为配置混乱而找不到正确的 CRT 库，它就无法解析这些符号，从而报错。

### **你是如何解决的？**

你通过修改 premake5.lua 脚本，为解决方案中的**所有项目**统一了运行时库的设置，从而解决了这个问题。

**关键的修复措施：**

1. **为你的项目 (Snail 和 Example) 设置运行时库**:
   在 premake5.lua 中，你为每个项目添加了 filter 块：

   ```
   filter "configurations:Debug"
       runtime "Debug" -- 这会强制使用 /MDd (多线程调试 DLL)
   
   filter "configurations:Release"
       runtime "Release" -- 这会强制使用 /MD (多线程 DLL)
   ```

2. **为第三方库 (GLFW) 设置相同的运行时库**:
   你没有链接一个预编译的 GLFW.lib，而是将 GLFW 的 premake5.lua 文件 include 进来，使其成为你解决方案的一部分。这意味着 **GLFW 项目也会继承你工作区 (workspace) 的配置**，包括 Debug 和 Release。你在 GLFW 的项目定义中也正确地设置了 runtime：

   ```
   project "GLFW"
       -- ...
       filter "configurations:Debug"
           runtime "Debug" -- 确保 GLFW 也使用 /MDd
       
       filter "configurations:Release"
           runtime "Release" -- 确保 GLFW 也使用 /MD
   ```

   同时，staticruntime "off" 也明确了你希望使用动态链接的 CRT。