# 12.13imgui的窗口事件处理

上次笔记我们创建了imgui视口，可以承载离屏渲染的内容；但之前我们的**“渲染内容”**逻辑上是glfw窗口事件，现在则变成了视口这个imgui窗口自身的事件：

之前只需要区分imgui和glfw事件，而现在需要特殊处理视口。

imgui本身就是调用OpenGL api来实现的ui绘制，它自身也能监听glfw的窗口事件。

在我的ImguiLayer中，OnEvent函数之前没有对事件进行拦截（设置事件的处理状态），也就是说所有事件对于imgui来说都要“穿透”。对应我们的主程序来说，imgui是上层，所以如果我希望渲染界面能响应我的鼠标/键盘，我就应该让imgui层穿透事件，反之我希望有时候当我操作imgui本身时，不希望画面响应我，那么我就应该让imgui拦截事件，即把事件的状态设置为已经处理。

```
ImGuiIO& io = ImGui::GetIO();

 if (m_BlockMouseEvents) {

 // 如果是鼠标事件，且 ImGui 想要捕获鼠标，则拦截

     if (event.IsEventInCategory(EventCategory::MouseCategoryEvent) && io.WantCaptureMouse) {

     	event.SetHandled(true);

     }
}


if (m_BlockKeyEvents)

{

    // 当视口依据自身聚焦状态给出 m_BlockKeyEvents 状态为真（视口未聚焦，事件属于其它imgui窗口）

    // 只要是键盘事件，直接拦截

    // 不管 io.WantCaptureKeyboard 是真是假

    if (event.IsEventInCategory(EventCategory::KeyboardCategoryEvent))

    {

    	event.SetHandled(true);

    }
}
```

上述代码表示的就是：我希望只要鼠标悬浮在我的视口上，鼠标事件就应该穿透；只要我聚焦在其他imgui窗口中，键盘事件就要被拦截。

值得一提的是：在之前framebuffer实现离屏渲染后，我创建了一个imgui窗口作为视口显示之前渲染的内容，此时视口本身也是imgui窗口，我们要怎么判断应不应该穿透呢？

方法就是在ImGui.Begin和End之间，有一些函数可以逐帧检测本窗口是不是被聚焦或者鼠标悬浮，我们去检测视口这个窗口，并根据状态设置ImguiLayer中的2个事件阻塞状态，分别控制鼠标事件和键盘事件，如果视口窗口说我们现在要放行事件，那么此时阻塞状态就会被对应设置为0，在OnEvent监听中，就会直接略过事件状态设置为true的函数，从而实现事件处理，反之也是一样，当视口表示现在我们不应该操控渲染画面时，阻塞状态就是1了。

```
// ---------------- 处理imgui事件 -------------------
bool isHovered = ImGui::IsWindowHovered();
bool isFocused = ImGui::IsWindowFocused();

bool isOperating = ImGui::IsMouseDown(ImGuiMouseButton_Right) || ImGui::IsMouseDown(ImGuiMouseButton_Middle);
if (isFocused && isOperating) {// 从视口内拖拽鼠标到视口外的情况
    isHovered = true; // 强制保持 Hover 状态，防止拦截开启
}
m_ViewportHovered = isHovered;
m_ViewportFocused = isFocused;

// 如果鼠标悬停，且点击了任意键，强制设置 ImGui 焦点到当前窗口
if (m_ViewportHovered && ImGui::IsMouseClicked(ImGuiMouseButton_Left) ||
    m_ViewportHovered && ImGui::IsMouseClicked(ImGuiMouseButton_Right) ||
    m_ViewportHovered && ImGui::IsMouseClicked(ImGuiMouseButton_Middle)) {

    ImGui::SetWindowFocus();
}

Application::Get().GetImGuiLayer()->BlockMouseEvents(!m_ViewportHovered);
Application::Get().GetImGuiLayer()->BlockKeyEvents(!m_ViewportFocused);
//SNL_CORE_WARN("Hovered {0}", m_ViewportHovered);
//SNL_CORE_WARN("Focused {0}", m_ViewportFocused);
```

>目标是：鼠标 一旦悬浮在视口 imgui就忽略鼠标事件；一旦聚焦于视口 imgui就忽略键盘事件；当鼠标悬浮在视口以外其它部分时，imgui应该拦截鼠标事件；当聚焦于视口以外其它部分时，imgui应该拦截键盘事件。